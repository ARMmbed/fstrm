<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>fstrm: Library overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">fstrm
   &#160;<span id="projectnumber">0.2.0-pre</span>
   </div>
   <div id="projectbrief">Frame Streams implementation in C</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('overview.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Library overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="init"></a>
Initializing the library</h1>
<p><code>fstrm</code> has no global library state. In most cases, only a single <code>fstrm_io</code> library context object will be needed for the entire process, which will implicitly create a background I/O serialization thread. This I/O thread is bound to a particular output (for example, an <code>AF_UNIX</code> socket) and is fully buffered &ndash; submitted data frames will be accumulated in an output buffer and periodically flushed, minimizing the number of system calls that need to be performed.</p>
<p>In order to create the <code>fstrm_io</code> library context object, the caller first needs to create an <code>fstrm_io_options</code> object which will be used to set any needed options, and then pass this options object to the <a class="el" href="group__fstrm__io.html#ga8884c56475e2f106859a09302dbb0034" title="Initialize an fstrm_io object. ">fstrm_io_init()</a> function. This options object may then be immediately destroyed after the <code>fstrm_io</code> object has been successfully created. See the <a class="el" href="group__fstrm__io.html">fstrm_io</a> module documentation for a detailed list of the options that can be set on an <code>fstrm_io</code> object.</p>
<p>Most of the settings which can be configured for an <code>fstrm_io</code> object are optional, except for the <code>writer</code> parameter, which is required. See the <a class="el" href="group__fstrm__io.html#gaa4c688613ff342028d5e48ed68bd8d13" title="Set the writer implementation to use for the output stream. ">fstrm_io_options_set_writer()</a> function and the <a class="el" href="group__fstrm__writer.html">fstrm_writer</a> module documentation for details. <code>fstrm_writer</code> is an abstract interface that can be used to connect a byte stream output into the <code>fstrm_io</code> processing loop. Several concrete implementations of the <code>fstrm_writer</code> interface are included in <code>libfstrm</code>, such as <a class="el" href="group__fstrm__file__writer.html">fstrm_file_writer</a>, which writes its output to a regular file, and <a class="el" href="group__fstrm__unix__writer.html">fstrm_unix_writer</a>, which writes its output to a stream-oriented <code>AF_UNIX</code> socket.</p>
<p>The following code example shows the initialization of the <code>fstrm_io</code> library context object connected to an <code>fstrm_file_writer</code> output. </p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *file_path = <span class="stringliteral">&quot;/tmp/output.fs&quot;</span>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>fstrm_file_writer_options *wopt;</div>
<div class="line">wopt = <a class="code" href="group__fstrm__file__writer.html#gacacd1547601021d3181deab09405280e" title="Initialize an fstrm_file_writer_options object, which is needed to configure fstrm_file_writer. ">fstrm_file_writer_options_init</a>();</div>
<div class="line"><a class="code" href="group__fstrm__file__writer.html#ga1783ea3bea0c9f1b8369a8e6ade375f1" title="Set the file_path option. ">fstrm_file_writer_options_set_file_path</a>(wopt, file_path);</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>fstrm_io_options *fopt;</div>
<div class="line">fopt = <a class="code" href="group__fstrm__io.html#gab57a03166e6cee802c6a8cce813cc106" title="Initialize an fstrm_io_options object, which is needed by fstrm_io_init(). ">fstrm_io_options_init</a>();</div>
<div class="line"><a class="code" href="group__fstrm__io.html#gaa4c688613ff342028d5e48ed68bd8d13" title="Set the writer implementation to use for the output stream. ">fstrm_io_options_set_writer</a>(fopt, <a class="code" href="group__fstrm__file__writer.html#ga0d017a7713d31c63587fffda67d79225" title="An fstrm_writer implementation that writes Frame Streams content to a regular file. ">fstrm_file_writer</a>, wopt);</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">char</span> *errstr = NULL;</div>
<div class="line"><span class="keyword">struct </span>fstrm_io *fio;</div>
<div class="line">fio = <a class="code" href="group__fstrm__io.html#ga8884c56475e2f106859a09302dbb0034" title="Initialize an fstrm_io object. ">fstrm_io_init</a>(fopt, &amp;errstr);</div>
<div class="line"><span class="keywordflow">if</span> (!fio) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error: fstrm_io_init() failed: %s\n&quot;</span>, errstr);</div>
<div class="line">        free(errstr);</div>
<div class="line">        exit(EXIT_FAILURE);</div>
<div class="line">}</div>
<div class="line"><a class="code" href="group__fstrm__io.html#gaed60ee50b93a0779298e54dfdca40865" title="Destroy an fstrm_io_options object. ">fstrm_io_options_destroy</a>(&amp;fopt);</div>
<div class="line"><a class="code" href="group__fstrm__file__writer.html#gab4745a8688a5698106064bc1f5152d5e" title="Destroy an fstrm_file_writer_options object. ">fstrm_file_writer_options_destroy</a>(&amp;wopt);</div>
</div><!-- fragment --><h1><a class="anchor" id="queue"></a>
Getting a queue</h1>
<p>After the <code>fstrm_io</code> object has been created with <a class="el" href="group__fstrm__io.html#ga8884c56475e2f106859a09302dbb0034" title="Initialize an fstrm_io object. ">fstrm_io_init()</a>, a queue handle can be obtained with the <a class="el" href="group__fstrm__io.html#ga5f7dc2ffd79c36977972050fca55c5a1" title="Obtain an fstrm_queue object for submitting data frames to the fstrm_io object. ">fstrm_io_get_queue()</a> function, which returns an <code>fstrm_queue</code> object. This function is thread-safe and will return a unique queue handle each time it is called, up to the number of queues specified by <a class="el" href="group__fstrm__io.html#gaeab932d83d6cdebada2a85c491ffd0dd" title="Set the num_queues option. ">fstrm_io_options_set_num_queues()</a>. <code>fstrm_queue</code> objects belong to their parent <code>fstrm_io</code> object and will be destroyed when the parent <code>fstrm_io</code> object is destroyed.</p>
<p>The following code example shows a single <code>fstrm_queue</code> handle being obtained from an already initialized <code>fstrm_io</code> library context object. </p>
<div class="fragment"><div class="line"><span class="comment">// &#39;fio&#39; is a struct fstrm_io *</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>fstrm_queue *fq;</div>
<div class="line">fq = <a class="code" href="group__fstrm__io.html#ga5f7dc2ffd79c36977972050fca55c5a1" title="Obtain an fstrm_queue object for submitting data frames to the fstrm_io object. ">fstrm_io_get_queue</a>(fio);</div>
<div class="line"><span class="keywordflow">if</span> (!fq) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error: fstrm_io_get_queue() failed.\n&quot;</span>);</div>
<div class="line">        exit(EXIT_FAILURE);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="submit"></a>
Submitting data frames</h1>
<p>Once the <code>fstrm_io</code> object has been created and an <code>fstrm_queue</code> handle is available, data frames can be submitted for asynchronous writing using the <a class="el" href="group__fstrm__io.html#gab4287d59ce3a396c5725e55645b1db66" title="Submit a data frame to the background I/O thread. ">fstrm_io_submit()</a> function. A callback is passed through this function which will be invoked to deallocate the data frame once the I/O thread has completed processing it. In the common case where the data frame is dynamically allocated with <code>malloc()</code>, the deallocation callback must call <code>free()</code>. <a class="el" href="group__fstrm__io.html#gaeb33a015a20c5b70966bb45b5afb9923" title="Wrapper function for the system&#39;s free() function suitable for use as a callback to fstrm_io_submit()...">fstrm_free_wrapper()</a> is provided as a convenience function which does this.</p>
<p>If space is available in the queue, <a class="el" href="group__fstrm__io.html#gab4287d59ce3a396c5725e55645b1db66" title="Submit a data frame to the background I/O thread. ">fstrm_io_submit()</a> will return <a class="el" href="group__constants.html#ggad3cb32b083ff99d02ccfbc1a69823329a6c9f6b085d2d3479f30d175978355b54" title="Success. ">FSTRM_RES_SUCCESS</a>, indicating that ownership of the memory allocation for the data frame has passed from the caller to the library. The caller must not reuse or deallocate the memory for the data frame after a successful call to <a class="el" href="group__fstrm__io.html#gab4287d59ce3a396c5725e55645b1db66" title="Submit a data frame to the background I/O thread. ">fstrm_io_submit()</a>.</p>
<p>Callers must check the return value of <a class="el" href="group__fstrm__io.html#gab4287d59ce3a396c5725e55645b1db66" title="Submit a data frame to the background I/O thread. ">fstrm_io_submit()</a>. If this function fails, that is, it returns any result code other than <a class="el" href="group__constants.html#ggad3cb32b083ff99d02ccfbc1a69823329a6c9f6b085d2d3479f30d175978355b54" title="Success. ">FSTRM_RES_SUCCESS</a>, the caller must deallocate or otherwise dispose of memory allocated for the data frame, in order to avoid leaking memory. <a class="el" href="group__fstrm__io.html#gab4287d59ce3a396c5725e55645b1db66" title="Submit a data frame to the background I/O thread. ">fstrm_io_submit()</a> can fail with <a class="el" href="group__constants.html#ggad3cb32b083ff99d02ccfbc1a69823329aee347e246bd19e4154f6739280222704" title="Resource temporarily unavailable. ">FSTRM_RES_AGAIN</a> if there is currently no space in the circular queue for an additional frame, in which case a later call to <a class="el" href="group__fstrm__io.html#gab4287d59ce3a396c5725e55645b1db66" title="Submit a data frame to the background I/O thread. ">fstrm_io_submit()</a> with the same parameters may succeed. However, if <a class="el" href="group__fstrm__io.html#gab4287d59ce3a396c5725e55645b1db66" title="Submit a data frame to the background I/O thread. ">fstrm_io_submit()</a> fails with <a class="el" href="group__constants.html#ggad3cb32b083ff99d02ccfbc1a69823329a9b6a06cc20558c0fcffdc234cc29e762" title="Parameters were invalid. ">FSTRM_RES_INVALID</a>, then there is a problem with the parameters and a later call will not succeed.</p>
<p>The following code example shows data frames containing a short sequence of bytes being created and submitted repeatedly, with appropriate error handling. Note that the data frames in this example intentionally contain embedded unprintable characters, showing that Frame Streams is binary clean. This example follows from the previous examples, where the <code>fio</code> and <code>fq</code> variables have already been initialized. </p>
<div class="fragment"><div class="line"><span class="comment">// &#39;fio&#39; is a struct fstrm_io *</span></div>
<div class="line"><span class="comment">// &#39;fq&#39; is a struct fstrm_queue *</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> num_frames = 100;</div>
<div class="line"><span class="keyword">const</span> uint8_t frame_template[] = {</div>
<div class="line">        <span class="charliteral">&#39;H&#39;</span>, <span class="charliteral">&#39;e&#39;</span>, <span class="charliteral">&#39;l&#39;</span>, <span class="charliteral">&#39;l&#39;</span>, <span class="charliteral">&#39;o&#39;</span>,</div>
<div class="line">        0x00, 0x01, 0x02, 0x03,</div>
<div class="line">        <span class="charliteral">&#39;W&#39;</span>, <span class="charliteral">&#39;o&#39;</span>, <span class="charliteral">&#39;r&#39;</span>, <span class="charliteral">&#39;l&#39;</span>, <span class="charliteral">&#39;d&#39;</span>,</div>
<div class="line">        0x04, 0x05, 0x06, 0x07,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; num_frames; i++) {</div>
<div class="line">        <span class="comment">// Allocate a new frame from the template.</span></div>
<div class="line">        uint8_t *frame = malloc(<span class="keyword">sizeof</span>(frame_template));</div>
<div class="line">        <span class="keywordflow">if</span> (!frame)</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        memcpy(frame, frame_template, <span class="keyword">sizeof</span>(frame_template));</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Submit the frame for writing.</span></div>
<div class="line">        <span class="keywordflow">for</span> (;;) {</div>
<div class="line">                <a class="code" href="group__constants.html#gad3cb32b083ff99d02ccfbc1a69823329" title="Result codes for functions. ">fstrm_res</a> res;</div>
<div class="line">                res = <a class="code" href="group__fstrm__io.html#gab4287d59ce3a396c5725e55645b1db66" title="Submit a data frame to the background I/O thread. ">fstrm_io_submit</a>(fio, fq, frame,</div>
<div class="line">                                      <span class="keyword">sizeof</span>(frame_template),</div>
<div class="line">                                      <a class="code" href="group__fstrm__io.html#gaeb33a015a20c5b70966bb45b5afb9923" title="Wrapper function for the system&#39;s free() function suitable for use as a callback to fstrm_io_submit()...">fstrm_free_wrapper</a>, NULL);</div>
<div class="line">                <span class="keywordflow">if</span> (res == <a class="code" href="group__constants.html#ggad3cb32b083ff99d02ccfbc1a69823329a6c9f6b085d2d3479f30d175978355b54" title="Success. ">FSTRM_RES_SUCCESS</a>) {</div>
<div class="line">                        <span class="comment">// Frame successfully queued.</span></div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == <a class="code" href="group__constants.html#ggad3cb32b083ff99d02ccfbc1a69823329aee347e246bd19e4154f6739280222704" title="Resource temporarily unavailable. ">FSTRM_RES_AGAIN</a>) {</div>
<div class="line">                        <span class="comment">// Queue is full. Try again in a busy loop.</span></div>
<div class="line">                        <span class="keywordflow">continue</span>;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                        <span class="comment">// Permanent failure.</span></div>
<div class="line">                        free(frame);</div>
<div class="line">                        fputs(<span class="stringliteral">&quot;fstrm_io_submit() failed.\n&quot;</span>, stderr);</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">        }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="shutdown"></a>
Shutting down</h1>
<p>Calling <a class="el" href="group__fstrm__io.html#ga143b807ae146b56f6f3b759f40220fd5" title="Destroy an fstrm_io object. ">fstrm_io_destroy()</a> on the <code>fstrm_io</code> object will signal the I/O thread to flush any outstanding data frames being written and will deallocate all associated resources. This function is synchronous and does not return until the I/O thread has terminated. </p>
<div class="fragment"><div class="line"><span class="comment">// &#39;fio&#39; is a struct fstrm_io *</span></div>
<div class="line"><a class="code" href="group__fstrm__io.html#ga143b807ae146b56f6f3b759f40220fd5" title="Destroy an fstrm_io object. ">fstrm_io_destroy</a>(&amp;fio);</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
